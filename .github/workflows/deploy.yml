name: Deploy to AWS

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  AWS_REGION: eu-west-3
  TF_WORKING_DIR: ./terraform/envs/dev

jobs:
  deploy:
    name: Deploy Infrastructure and App
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0
          terraform_wrapper: false

      - name: Setup Python (for Ansible)
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible boto3 botocore

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Setup Deployment SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_rsa.pub
          chmod 600 ~/.ssh/id_rsa
          chmod 644 ~/.ssh/id_rsa.pub

      - name: Get Runner IP
        id: ip
        run: echo "ipv4=$(curl -s https://checkip.amazonaws.com)" >> $GITHUB_OUTPUT

      - name: Terraform Apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform apply -auto-approve -no-color \
            -var="public_key_path=$HOME/.ssh/id_rsa.pub" \
            -var="aws_profile=" \
            -var="allowed_ssh_cidr=${{ steps.ip.outputs.ipv4 }}/32"
          
          terraform output -no-color -json > tf_outputs.json
          echo "::group::Debug tf_outputs.json"
          cat tf_outputs.json
          echo "::endgroup::"

      - name: Generate Inventory
        run: |
          python3 ansible/scripts/generate_inventory.py \
            --tf-output ${{ env.TF_WORKING_DIR }}/tf_outputs.json \
            --inventory ansible/inventories/dev/hosts.ini \
            --ssh-key ~/.ssh/id_rsa

      - name: Wait for SSH to be ready
        run: |
          echo "Waiting for SSH to be available..."
          # Fetch IP from inventory file (simple grep)
          IP=$(grep -oE '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' ansible/inventories/dev/hosts.ini | head -1)
          
          # Loop until netcat (nc) can connect to port 22
          for i in {1..30}; do
            nc -z -w 5 $IP 22 && echo "SSH is up!" && exit 0
            echo "Waiting for SSH..."
            sleep 10
          done
          echo "SSH failed to start in time."
          exit 1
        
      - name: Run Ansible Playbook
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
           ansible-playbook -i ansible/inventories/dev/hosts.ini ansible/playbook.yml
