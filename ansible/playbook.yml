---
# Cloud-1 bootstrap (Ubuntu target)
# This playbook is safe to run on a remote VM or directly on the VM itself
# (use inventory 'localhost' with ansible_connection=local).

- name: Cloud-1 bootstrap (Ubuntu target)
  hosts: all
  become: true
  vars:
    repo_url: "https://github.com/ychun816/cloud-1.git"
    repo_version: "master"
    app_dir: /opt/cloud-1
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install prerequisites
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - python3-apt
          - python3-pip
          - ufw
        state: present

    - name: Install Docker (official repo) key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker apt repo
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable"
        state: present

    - name: Install Docker engine and compose plugin
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Ensure docker group exists
      group:
        name: docker
        state: present

    - name: Add current SSH user to docker group
      user:
        name: "{{ ansible_user_id }}"
        groups: docker
        append: yes

    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid | default(ansible_user_id) }}"
        mode: '0755'

    - name: Clone project repo
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_dir }}"
        version: "{{ repo_version }}"
        force: yes

    - name: Allow SSH, HTTP, HTTPS in UFW
      ufw:
        rule: allow
        port: "{{ item }}"
      loop: [22, 80, 443]

    - name: Enable UFW firewall
      ufw:
        state: enabled
        policy: deny
      register: ufw_enabled
      ignore_errors: true

    - name: Disable root password login in sshd_config
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present
        backup: yes

    - name: Restart ssh
      service:
        name: ssh
        state: restarted

    - name: Create systemd service to run docker compose
      copy:
        dest: /etc/systemd/system/cloud-1.service
        content: |
          [Unit]
          Description=Cloud-1 docker-compose
          After=network.target docker.service
          Requires=docker.service

          [Service]
          Type=oneshot
          RemainAfterExit=yes
          WorkingDirectory={{ app_dir }}/compose
          ExecStart=/usr/bin/docker compose -f {{ app_dir }}/compose/docker-compose.yml up -d
          ExecStop=/usr/bin/docker compose -f {{ app_dir }}/compose/docker-compose.yml down
          TimeoutStartSec=0

          [Install]
          WantedBy=multi-user.target
      notify: daemon-reload

    - name: Enable and start cloud-1 service
      systemd:
        name: cloud-1.service
        enabled: yes
        state: started

  handlers:
    - name: daemon-reload
      command: systemctl daemon-reload
