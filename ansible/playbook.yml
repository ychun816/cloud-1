# targets cloud servers
# installs Docker
# deploys a project
# configures security
# manages systemd

- name: Cloud-1 bootstrap (Ubuntu target)
  hosts: all
  gather_facts: false  # Skip initial gathering to prevent Python version error
  become: true
  
  pre_tasks:
    - name: Bootstrap Python 3.9+ manually
      raw: |
        apt-get update && \
        apt-get install -y software-properties-common && \
        add-apt-repository -y ppa:deadsnakes/ppa && \
        apt-get update && \
        apt-get install -y python3.9 python3.9-distutils python3-apt
      args:
        executable: /bin/bash
      failed_when: false
      changed_when: false

    - name: Set Python 3.9 as default
    # raw : bridge up ansible 3.9 and ubuntu 3.8 python 
      raw: |
        update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.8 1 && \
        update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.9 2
      changed_when: false

    - name: Fix apt_pkg and dist-packages for Python 3.9
      raw: | 
        cd /usr/lib/python3/dist-packages && \
        cp -n apt_pkg.cpython-38-x86_64-linux-gnu.so apt_pkg.so || true && \
        cp -n apt_inst.cpython-38-x86_64-linux-gnu.so apt_inst.so || true && \
        if [ -d "/usr/lib/python3.9" ]; then \
            echo "/usr/lib/python3/dist-packages" > /usr/lib/python3.9/dist-packages.pth; \
        fi && \
        if [ -d "/usr/local/lib/python3.9/site-packages" ]; then \
            echo "/usr/lib/python3/dist-packages" > /usr/local/lib/python3.9/site-packages/dist-packages.pth; \
        fi
      args:
        executable: /bin/bash
      failed_when: false
      changed_when: false

  # Now we can gather facts properly with the new Python
  tasks:
    - name: Gather Facts
      ansible.builtin.setup:

- name: Deploy cloud-1 compose stack
  hosts: web
  become: true
  vars_files:
    - variables.yml
  roles:
    - docker
    - cloudwatch

- name: Cloud-1 configuration continued
  hosts: all
  become: true
  vars:
    repo_url: "https://github.com/ychun816/cloud-1.git"
    app_dir: /opt/cloud-1

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install prerequisites
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - python3-apt
          - ufw
        state: present

    - name: Install Docker (official repo)
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      register: docker_key

    - name: Add Docker apt repo
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename | default('focal') }} stable"
        state: present

    - name: Install docker packages
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: true
      failed_when: false

    - name: Ensure docker group exists
      ansible.builtin.group:
        name: docker
        state: present

  # fix conflict ansible 3.9 and unbuntu installer 3.8 for python
  # go online to download latest installer 
    - name: Ensure pip is installed
      raw: |
        curl -sS https://bootstrap.pypa.io/get-pip.py | python3
      changed_when: true

    - name: Install OpenSSL for pip compatibility
      raw: |
        /usr/local/bin/pip3 install --upgrade pyopenssl>=22.0.0 cryptography>=37.0.0
      changed_when: true

    - name: Install docker-compose plugin via pip
      raw: |
        /usr/local/bin/pip3 install docker-compose
      changed_when: true

    # Ansible is just the manager that installs Docker
    # docker deplay ngnix / wordpress / mairadb
    # - name: Clone project repo
    #   ansible.builtin.git:
    #     repo: "{{ repo_url }}"
    #     dest: "{{ app_dir }}"
    #     version: master
    #     force: true

    - name: Allow SSH, HTTP, HTTPS in UFW
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
      loop: [22, 80, 443]

    - name: Disable root password login in sshd_config
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present
        backup: true

    - name: Restart ssh
      ansible.builtin.service:
        name: ssh
        state: restarted

    - name: Create systemd service to run docker compose
      ansible.builtin.copy:
        dest: /etc/systemd/system/cloud-1.service
        content: |
          [Unit]
          Description=Cloud-1 docker-compose
          After=network.target docker.service
          Requires=docker.service

          [Service]
          Type=oneshot
          RemainAfterExit=yes
          WorkingDirectory={{ app_dir }}/compose
          Environment="DATA_DIR={{ app_dir }}/data"
          ExecStart=/usr/bin/docker compose up -d
          ExecStop=/usr/bin/docker compose down
          TimeoutStartSec=0

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      notify: Daemon reload

    - name: Force systemd reload if service changed
      ansible.builtin.meta: flush_handlers

    - name: Enable and start cloud-1 service
      ansible.builtin.service:
        name: cloud-1
        state: started
        enabled: true

  handlers:
    - name: Daemon reload
      ansible.builtin.systemd:
        daemon_reload: true
      become: true

# End of playbook
